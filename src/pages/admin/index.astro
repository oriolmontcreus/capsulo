---
import AdminLayout from "@/layouts/admin.layout.astro";
import AppWrapper from "@/components/admin/AppWrapper";
import { capsuloConfig } from "@/lib/config";
import { loadPageData, loadGlobalData } from "@/lib/cms-loader";
import componentManifest from "virtual:component-manifest";

const GITHUB_OWNER = capsuloConfig.github.owner;
const GITHUB_REPO = capsuloConfig.github.repo;

// Get all page files from the pages directory, excluding admin subdirectory
const pageFiles = import.meta.glob("../**/*.astro", { eager: true });

console.log("Page files found:", Object.keys(pageFiles));
console.log("Component manifest:", componentManifest);

// CRITICAL DEBUG: Test the mapping directly
const testPath = "../index.astro";
const testCleanPath = testPath.replace("../", "").replace(".astro", "");
const testSegments = testCleanPath.split("/").filter(s => s);
const testFileName = testSegments[testSegments.length - 1];
console.log("ðŸ”¬ TEST MAPPING:");
console.log("  testPath:", testPath);
console.log("  testCleanPath:", testCleanPath);
console.log("  testSegments:", testSegments);
console.log("  testFileName:", testFileName);
console.log("  segments.length === 1?", testSegments.length === 1);
console.log("  fileName === 'index'?", testFileName === "index");
if (testFileName === "index" && testSegments.length === 1) {
  console.log("  âœ… Should map to pageId: 'index'");
  console.log("  componentManifest['index']:", componentManifest["index"]);
  console.log("  Has components?", componentManifest["index"] && componentManifest["index"].length > 0);
} else {
  console.log("  âŒ Mapping logic failed!");
}

console.log("=".repeat(80));
console.log("[Admin] DEBUG: Starting page detection");
console.log("[Admin] All page file paths:", Object.keys(pageFiles));
console.log("[Admin] Component manifest keys:", Object.keys(componentManifest));
console.log("[Admin] Component manifest:", JSON.stringify(componentManifest, null, 2));
console.log("=".repeat(80));

const availablePages = Object.keys(pageFiles)
  .filter((path) => {
    // Apply page filter regex from config
    const pageFilterRegex = new RegExp(
      capsuloConfig.ui?.pageFilterRegex || "^(?!.*\\/admin\\/).*$",
    );
    const matches = pageFilterRegex.test(path);
    console.log(`[Admin] Path "${path}" matches filter: ${matches}`);
    return matches;
  })
  .map((path) => {
    // Handle both ../index.astro and ../../index.astro (filter out the latter)
    if (path.startsWith("../../")) {
      console.log(`[Admin] âš ï¸ Skipping path outside pages directory: "${path}"`);
      return null;
    }

    const cleanPath = path.replace("../", "").replace(".astro", "");
    const segments = cleanPath.split("/").filter(s => s); // Filter empty strings
    const fileName = segments[segments.length - 1];

    let pageId: string;
    let pageName: string;

    console.log(`[Admin] ðŸ” Processing path: "${path}"`);
    console.log(`[Admin]   cleanPath: "${cleanPath}"`);
    console.log(`[Admin]   segments:`, segments);
    console.log(`[Admin]   fileName: "${fileName}"`);

    if (fileName === "index") {
      // Root index.astro (no parent directory)
      if (segments.length === 1) {
        pageId = "index";
        pageName = "Home";
        console.log(`[Admin]   âœ… Root index detected -> pageId: "index"`);
      } else {
        // [locale]/index.astro or other folder/index.astro
        const parentDir = segments[segments.length - 2];
        if (parentDir === "[locale]") {
          // [locale]/index.astro maps to "index" in manifest
          pageId = "index";
          pageName = "Home";
          console.log(`[Admin]   âœ… [locale]/index detected -> pageId: "index"`);
        } else {
          pageId = parentDir;
          pageName = parentDir.charAt(0).toUpperCase() + parentDir.slice(1);
          console.log(`[Admin]   âœ… Folder index detected -> pageId: "${pageId}"`);
        }
      }
    } else {
      // Remove [locale] prefix if present
      const pathWithoutLocale = segments.filter((s) => s !== "[locale]");
      pageId = pathWithoutLocale.join("-");
      pageName = fileName.charAt(0).toUpperCase() + fileName.slice(1);
      console.log(`[Admin]   âœ… Regular page -> pageId: "${pageId}"`);
    }

    // Debug logging
    console.log(`[Admin]   ðŸ“‹ Final mapping: "${path}" -> pageId: "${pageId}", pageName: "${pageName}"`);
    console.log(`[Admin]   ðŸ“¦ componentManifest["${pageId}"]:`, componentManifest[pageId]);
    const hasComponents = componentManifest[pageId] && componentManifest[pageId].length > 0;
    console.log(`[Admin]   ${hasComponents ? 'âœ…' : 'âŒ'} Has components: ${hasComponents}`);

    return { id: pageId, name: pageName, path };
  })
  .filter((page) => page !== null) // Remove null entries from skipped paths
  // Filter to only include pages that have components in the manifest
  .filter((page) => {
    const hasComponents = componentManifest[page.id] && componentManifest[page.id].length > 0;
    if (!hasComponents) {
      console.log(`[Admin] âŒ Filtering out page "${page.name}" (id: "${page.id}") - no components in manifest`);
      console.log(`[Admin]   componentManifest[${page.id}]:`, componentManifest[page.id]);
    } else {
      console.log(`[Admin] âœ… Keeping page "${page.name}" (id: "${page.id}") - has components`);
    }
    return hasComponents;
  })
  .sort((a, b) => a.name.localeCompare(b.name));

console.log("Available pages (with components):", availablePages);
console.log("[Admin] ðŸ“Š SUMMARY:");
console.log(`[Admin]   - Total page files found: ${Object.keys(pageFiles).length}`);
console.log(`[Admin]   - Component manifest keys: [${Object.keys(componentManifest).join(', ')}]`);
console.log(`[Admin]   - Available pages after filtering: ${availablePages.length}`);
console.log(`[Admin]   - Available page IDs: [${availablePages.map(p => p.id).join(', ')}]`);
if (availablePages.length === 0 && Object.keys(componentManifest).length > 0) {
  console.error("[Admin] âš ï¸ ISSUE DETECTED: Component manifest has entries but no pages matched!");
  console.error("[Admin]   This suggests a pageId mapping mismatch.");
  console.error("[Admin]   Component manifest pageIds:", Object.keys(componentManifest));
  console.error("[Admin]   All mapped pageIds from files:", 
    Object.keys(pageFiles)
      .filter(path => {
        const pageFilterRegex = new RegExp(capsuloConfig.ui?.pageFilterRegex || "^(?!.*\\/admin\\/).*$");
        return pageFilterRegex.test(path);
      })
      .map(path => {
        const cleanPath = path.replace("../", "").replace(".astro", "");
        const segments = cleanPath.split("/");
        const fileName = segments[segments.length - 1];
        if (fileName === "index" && segments.length === 1) return "index";
        if (fileName === "index" && segments.length > 1 && segments[segments.length - 2] === "[locale]") return "index";
        if (fileName === "index" && segments.length > 1) return segments[segments.length - 2];
        const pathWithoutLocale = segments.filter((s) => s !== "[locale]");
        return pathWithoutLocale.join("-");
      })
  );
}

if (availablePages.length === 0) {
  console.warn("No pages found! Adding default pages");
}

// Load initial CMS data for each page from JSON files
const initialData: Record<string, any> = {};

// Load data for each available page
for (const page of availablePages) {
  try {
    // Map page.id to the actual file name (e.g., 'home' -> 'index')
    const fileName = page.id === "home" ? "index" : page.id;
    const pageData = await loadPageData(fileName);

    if (pageData) {
      initialData[page.id] = pageData;
      console.log(`Loaded CMS data for ${page.id}:`, pageData);
    } else {
      // No data file exists yet, use empty components array
      initialData[page.id] = { components: [] };
      console.log(`No CMS data found for ${page.id}, using empty data`);
    }
  } catch (error) {
    console.error(`Error loading data for ${page.id}:`, error);
    initialData[page.id] = { components: [] };
  }
}

// Debug: Log the actual data being loaded
console.log("Initial data loaded:", JSON.stringify(initialData, null, 2));

// Load global variables data
let globalData = { variables: [] };
try {
  const loadedGlobalData = await loadGlobalData();
  if (loadedGlobalData) {
    globalData = loadedGlobalData;
    console.log("Loaded global variables data:", globalData);
  } else {
    console.log("No global variables data found, using empty data");
  }
} catch (error) {
  console.error("Error loading global variables data:", error);
  globalData = { variables: [] };
}

const content = {
  title: "TESTUI - Admin",
};
---

<AdminLayout content={content}>
  <AppWrapper
    client:load
    availablePages={availablePages}
    pagesData={initialData}
    globalData={globalData}
    componentManifest={componentManifest}
    githubOwner={GITHUB_OWNER}
    githubRepo={GITHUB_REPO}
  />
</AdminLayout>

---
import Layout from "@/layouts/main.astro";
import AppWrapper from "@/components/admin/AppWrapper";
import { config } from "@/lib/config";
import { loadPageData } from "@/lib/cms-loader";

const GITHUB_OWNER = config.github.owner;
const GITHUB_REPO = config.github.repo;

// Get all page files from the pages directory, excluding admin subdirectory
const pageFiles = import.meta.glob("../*.astro", { eager: true });

console.log("Page files found:", Object.keys(pageFiles));

const availablePages = Object.keys(pageFiles)
  .map((path) => {
    const cleanPath = path.replace("../", "").replace(".astro", "");
    const segments = cleanPath.split("/");
    const fileName = segments[segments.length - 1];

    let pageId: string;
    let pageName: string;

    if (fileName === "index" && segments.length === 1) {
      pageId = "home";
      pageName = "Home";
    } else if (fileName === "index") {
      const parentDir = segments[segments.length - 2];
      pageId = parentDir;
      pageName = parentDir.charAt(0).toUpperCase() + parentDir.slice(1);
    } else {
      pageId = segments.join("-");
      pageName = fileName.charAt(0).toUpperCase() + fileName.slice(1);
    }

    return { id: pageId, name: pageName, path };
  })
  .sort((a, b) => a.name.localeCompare(b.name));

console.log("Available pages:", availablePages);

if (availablePages.length === 0) {
  console.warn("No pages found! Adding default pages");
}

// Load initial CMS data for each page from JSON files
const initialData: Record<string, any> = {};

// Load data for each available page
for (const page of availablePages) {
  try {
    // Map page.id to the actual file name (e.g., 'home' -> 'index')
    const fileName = page.id === "home" ? "index" : page.id;
    const pageData = await loadPageData(fileName);

    if (pageData) {
      initialData[page.id] = pageData;
      console.log(`Loaded CMS data for ${page.id}:`, pageData);
    } else {
      // No data file exists yet, use empty components array
      initialData[page.id] = { components: [] };
      console.log(`No CMS data found for ${page.id}, using empty data`);
    }
  } catch (error) {
    console.error(`Error loading data for ${page.id}:`, error);
    initialData[page.id] = { components: [] };
  }
}

// Debug: Log the actual data being loaded
console.log("Initial data loaded:", JSON.stringify(initialData, null, 2));

const content = {
  title: "Capsulo CMS - Admin",
};
---

<Layout content={content}>
  <AppWrapper
    client:load
    availablePages={availablePages}
    pagesData={initialData}
    githubOwner={GITHUB_OWNER}
    githubRepo={GITHUB_REPO}
  />
</Layout>

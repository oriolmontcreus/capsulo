---
// This route serves the same content as /admin but allows the URL to reflect the current view
// The React client will read the URL and show the appropriate view
import AdminLayout from "@/layouts/admin.layout.astro";
import AppWrapper from "@/components/admin/AppWrapper";
import { capsuloConfig } from "@/lib/config";
import { loadPageData, loadGlobalData } from "@/lib/cms-loader";
import componentManifest from "virtual:component-manifest";

const GITHUB_OWNER = capsuloConfig.github.owner;
const GITHUB_REPO = capsuloConfig.github.repo;

// Get all page files from the pages directory, excluding admin subdirectory
const pageFiles = import.meta.glob("../../**/*.astro", { eager: true });

const availablePages = Object.keys(pageFiles)
  .filter((path) => {
    // Exclude admin entry point (../index.astro from admin/pages/ = admin/index.astro)
    if (path === "../index.astro") {
      return false;
    }

    // Apply page filter regex from config
    const pageFilterRegex = new RegExp(
      capsuloConfig.ui?.pageFilterRegex || "^(?!.*\\/admin\\/).*$",
    );
    return pageFilterRegex.test(path);
  })
  .map((path) => {
    // Skip paths that go outside the pages directory
    if (path.startsWith("../../../")) {
      return null;
    }

    // Handle root index.astro (../../index.astro from admin/pages/)
    // This is the actual site home page, not the admin entry point
    if (path === "../../index.astro") {
      return { id: "index", name: "Home", path };
    }

    const cleanPath = path.replace("../../", "").replace("../", "").replace(".astro", "");
    const segments = cleanPath.split("/").filter(s => s); // Filter empty strings
    const fileName = segments[segments.length - 1];

    let pageId: string;
    let pageName: string;

    if (fileName === "index") {
      // Root index.astro (no parent directory) - should be handled above, but just in case
      if (segments.length === 1) {
        pageId = "index";
        pageName = "Home";
      } else {
        // [locale]/index.astro or other folder/index.astro
        const parentDir = segments[segments.length - 2];
        if (parentDir === "[locale]") {
          // [locale]/index.astro maps to "index" in manifest
          pageId = "index";
          pageName = "Home";
        } else {
          pageId = parentDir;
          pageName = parentDir.charAt(0).toUpperCase() + parentDir.slice(1);
        }
      }
    } else {
      // Remove [locale] prefix if present
      const pathWithoutLocale = segments.filter((s) => s !== "[locale]");
      pageId = pathWithoutLocale.join("-");
      pageName = fileName.charAt(0).toUpperCase() + fileName.slice(1);
    }

    return { id: pageId, name: pageName, path };
  })
  .filter((page) => page !== null) // Remove null entries
  // Filter to only include pages that have components in the manifest
  .filter((page) => {
    return componentManifest[page.id] && componentManifest[page.id].length > 0;
  })
  // Deduplicate by pageId (keep the first occurrence, prefer root index.astro)
  .reduce((acc, page) => {
    const existing = acc.find(p => p.id === page.id);
    if (!existing) {
      acc.push(page);
    } else {
      // If we have a duplicate, prefer the root index.astro path
      if (page.path === "../../index.astro" && existing.path !== "../../index.astro") {
        const index = acc.indexOf(existing);
        acc[index] = page;
      }
    }
    return acc;
  }, [] as Array<{ id: string; name: string; path: string }>)
  .sort((a, b) => a.name.localeCompare(b.name));


// Load initial CMS data for each page from JSON files
const initialData: Record<string, any> = {};

// Load data for each available page
for (const page of availablePages) {
  try {
    // Map page.id to the actual file name (e.g., 'home' -> 'index')
    const fileName = page.id === "home" ? "index" : page.id;
    const pageData = await loadPageData(fileName);

    if (pageData) {
      initialData[page.id] = pageData;
    } else {
      // No data file exists yet, use empty components array
      initialData[page.id] = { components: [] };
    }
  } catch (error) {
    console.error(`Error loading data for ${page.id}:`, error);
    initialData[page.id] = { components: [] };
  }
}

// Load global variables data
let globalData: { variables: any[] } = { variables: [] };
try {
  const loadedGlobalData = await loadGlobalData();
  if (loadedGlobalData) {
    globalData = loadedGlobalData;
  }
} catch (error) {
  console.error("Error loading global variables data:", error);
  globalData = { variables: [] };
}

const content = {
  title: "TESTUI - Admin - Pages",
};
---

<AdminLayout content={content}>
  <AppWrapper
    client:load
    availablePages={availablePages}
    pagesData={initialData}
    globalData={globalData}
    componentManifest={componentManifest}
    githubOwner={GITHUB_OWNER}
    githubRepo={GITHUB_REPO}
  />
</AdminLayout>

---
/**
 * Admin SPA Entry Point
 *
 * This catch-all route handles all admin routes using client-side React Router.
 * No server-side data preloading - all data is fetched async via TanStack Query.
 *
 * Phase 5 of Admin SPA Refactor
 */
export const prerender = false;
import AdminRoot from "@/components/admin/AdminRoot";
import "@/styles/global.css";
---

<html lang="en">
    <head>
        <meta charset="utf-8" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="viewport" content="width=device-width" />
        <title>Admin Panel</title>
        <!-- Theme initialization to prevent flash -->
        <script is:inline>
            const getThemePreference = () => {
                if (
                    typeof localStorage !== "undefined" &&
                    localStorage.getItem("theme")
                ) {
                    return localStorage.getItem("theme");
                }
                return window.matchMedia("(prefers-color-scheme: dark)").matches
                    ? "dark"
                    : "light";
            };
            const isDark = getThemePreference() === "dark";
            document.documentElement.classList[isDark ? "add" : "remove"](
                "dark",
            );

            if (typeof localStorage !== "undefined") {
                const observer = new MutationObserver(() => {
                    const isDark =
                        document.documentElement.classList.contains("dark");
                    localStorage.setItem("theme", isDark ? "dark" : "light");
                });
                observer.observe(document.documentElement, {
                    attributes: true,
                    attributeFilter: ["class"],
                });
            }
        </script>
        <!-- Auth check - redirect to login if not authenticated -->
        <script is:inline>
            (function () {
                // Prevent redirect loop if already on login page
                if (window.location.pathname.startsWith("/admin/login")) {
                    return;
                }

                const token = localStorage.getItem("github_access_token");
                if (!token) {
                    // Redirect to login preserving current location for potential redirect back
                    window.location.href = "/admin/login";
                    return;
                }

                fetch("https://api.github.com/user", {
                    headers: { Authorization: "Bearer " + token },
                })
                    .then(function (res) {
                        if (res.status === 401) {
                            localStorage.removeItem("github_access_token");
                            localStorage.removeItem("github_user_data");
                            window.location.href = "/admin/login?expired=true";
                        }
                    })
                    .catch(function (err) {
                        console.warn(
                            "Token validation failed (network error):",
                            err.message,
                        );
                        // Network error - user remains authenticated but with unvalidated token
                        // This is acceptable as subsequent API calls will fail gracefully
                    });
            })();
        </script>
    </head>
    <body>
        <!-- 
            Mount the React Router App.
            client:only="react" is crucial because React Router strictly runs in the browser.
        -->
        <AdminRoot client:only="react" basename="/admin" />
    </body>
</html>

---
import Layout from '../../layouts/main.astro';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Spinner } from '@/components/ui/spinner';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Separator } from '@/components/ui/separator';

const content = {
  title: 'Login - Capsulo CMS',
};

// Import configuration
import capsuloConfig from '@/capsulo.config';
import Logo from '@/components/Logo';

// GitHub configuration from centralized config
const GITHUB_REPO_OWNER = capsuloConfig.github.owner;
const GITHUB_REPO_NAME = capsuloConfig.github.repo;
const APP_NAME = capsuloConfig.app.name;
const APP_VERSION = capsuloConfig.app.version;
const AUTH_WORKER_URL = capsuloConfig.app.authWorkerUrl;
---

<Layout content={content} hideLocaleSwitcher={true}>
  <div class="flex min-h-svh w-full items-center justify-center p-6 md:p-10">
    <div class="w-full max-w-sm">
      <div class="flex flex-col gap-6">
        <Card>
          <CardHeader className="text-center">
            <div class="flex justify-center mb-2">
              <Logo className="size-8" />
            </div>
            <CardTitle className="text-xl">Welcome back</CardTitle>
            <CardDescription> Sign in with your GitHub account to continue </CardDescription>
          </CardHeader>
          <CardContent>
            <div class="grid gap-6">
              <!-- Primary: GitHub OAuth Button -->
              <Button type="button" id="oauth-button" variant="outline" className="w-full">
                <svg class="mr-2 size-4" viewBox="0 0 24 24" fill="currentColor">
                  <path
                    d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
                  ></path>
                </svg>
                Continue with GitHub
              </Button>

              <!-- Error display -->
              <div id="error" class="hidden">
                <Alert variant="destructive">
                  <AlertDescription id="error-message" />
                </Alert>
              </div>

              <div class="relative text-center text-sm">
                <div class="absolute inset-0 flex items-center">
                  <Separator className="w-full" />
                </div>
                <span class="relative z-10 bg-card px-2 text-muted-foreground">
                  Or continue with token
                </span>
              </div>

              <!-- Secondary: Manual Token Entry -->
              <details class="group">
                <summary
                  class="cursor-pointer text-sm text-muted-foreground hover:text-foreground transition-colors flex items-center justify-center gap-2 list-none"
                >
                  <svg
                    class="size-4 transition-transform group-open:rotate-90"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <polyline points="9 18 15 12 9 6"></polyline>
                  </svg>
                  Sign in with Personal Access Token
                </summary>

                <div class="mt-4 space-y-4">
                  <form id="loginForm">
                    <div class="grid gap-4">
                      <div class="grid gap-2">
                        <Label htmlFor="token" className="sr-only">
                          GitHub Personal Access Token
                        </Label>
                        <div class="flex gap-2">
                          <Input
                            id="token"
                            type="password"
                            placeholder="github_pat_xxxxxxxxxxxxxxxxxxxx"
                            className="flex-1"
                            required
                          />
                          <Button
                            type="submit"
                            variant="outline"
                            id="submit-button"
                            className="w-20"
                          >
                            <span class="button-text">Login</span>
                            <Spinner className="spinner hidden" />
                          </Button>
                        </div>
                      </div>
                    </div>
                  </form>

                  <!-- Help section for manual tokens -->
                  <div class="text-xs text-muted-foreground space-y-2 p-3 bg-muted rounded-lg">
                    <p class="font-medium">How to create a Personal Access Token:</p>
                    <ol class="list-decimal list-inside space-y-1 ml-2">
                      <li>
                        Go to GitHub Settings → Developer settings → Personal access tokens →
                        Fine-grained tokens
                      </li>
                      <li>
                        Select the <strong>{GITHUB_REPO_OWNER}/{GITHUB_REPO_NAME}</strong> repository
                        and grant these permissions:
                        <ul class="list-disc list-inside ml-4 mt-1 space-y-0.5">
                          <li><strong>Contents:</strong> Read and Write</li>
                          <li><strong>Metadata:</strong> Read</li>
                          <li><strong>Email addresses:</strong> Read</li>
                        </ul>
                      </li>
                      <li>Copy and paste the token above</li>
                    </ol>
                    <p class="text-xs mt-2 opacity-75">
                      Fine-grained tokens start with <code
                        class="bg-muted-foreground/20 px-1 rounded">github_pat_</code
                      >
                    </p>
                  </div>
                </div>
              </details>
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  </div>

  <script
    define:vars={{
      GITHUB_REPO_OWNER,
      GITHUB_REPO_NAME,
      APP_NAME,
      APP_VERSION,
      AUTH_WORKER_URL,
    }}
  >
    // OAuth Button Handler with CSRF Protection
    const oauthButton = document.getElementById('oauth-button');
    oauthButton?.addEventListener('click', () => {
      // Generate cryptographically-random state for CSRF protection
      const stateArray = new Uint8Array(32);
      crypto.getRandomValues(stateArray);
      const state = Array.from(stateArray, (byte) => byte.toString(16).padStart(2, '0')).join('');

      // Store state in sessionStorage for verification on callback
      sessionStorage.setItem('oauth_state', state);

      // Redirect to the OAuth worker with state parameter
      const authUrl = new URL(`${AUTH_WORKER_URL}/auth`);
      authUrl.searchParams.set('client_state', state);
      window.location.href = authUrl.toString();
    });

    // Check for OAuth errors in URL params (redirected back with error)
    const urlParams = new URLSearchParams(window.location.search);
    const oauthError = urlParams.get('error');
    if (oauthError) {
      const errorDescription = urlParams.get('error_description');
      showError(errorDescription || `OAuth error: ${oauthError}`);
      // Clean up URL
      window.history.replaceState({}, document.title, window.location.pathname);
    }

    // Manual Token Form Handler
    const form = document.getElementById('loginForm');
    const tokenInput = document.getElementById('token');
    const errorDiv = document.getElementById('error');
    const errorMessage = document.getElementById('error-message');
    const buttonText = document.querySelector('.button-text');
    const spinner = document.querySelector('.spinner');
    const submitButton = document.getElementById('submit-button');

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const token = tokenInput?.value?.trim();
      if (!token) {
        showError('Please enter a valid GitHub token');
        return;
      }

      setLoading(true);
      hideError();

      try {
        // Validate token by fetching user data
        const userResponse = await fetch('https://api.github.com/user', {
          headers: {
            Authorization: `Bearer ${token}`,
            Accept: 'application/vnd.github.v3+json',
            'X-GitHub-Api-Version': '2022-11-28',
            'User-Agent': `${APP_NAME}/${APP_VERSION}`,
          },
        });

        if (!userResponse.ok) {
          const errorText = await userResponse.text();
          console.error('GitHub API Error:', userResponse.status, errorText);
          throw new Error(`Invalid GitHub token: ${userResponse.status}`);
        }

        const user = await userResponse.json();

        // Check repository access
        const repoResponse = await fetch(
          `https://api.github.com/repos/${GITHUB_REPO_OWNER}/${GITHUB_REPO_NAME}`,
          {
            headers: {
              Authorization: `Bearer ${token}`,
              Accept: 'application/vnd.github.v3+json',
              'X-GitHub-Api-Version': '2022-11-28',
              'User-Agent': `${APP_NAME}/${APP_VERSION}`,
            },
          }
        );

        if (!repoResponse.ok) {
          const errorText = await repoResponse.text();
          console.error('Repository Access Error:', repoResponse.status, errorText);
          throw new Error(`You do not have access to this repository: ${repoResponse.status}`);
        }

        // Store authentication data
        localStorage.setItem('github_access_token', token);
        localStorage.setItem('github_user_data', JSON.stringify(user));

        // Redirect to main page
        window.location.href = '/';
      } catch (error) {
        const errorMsg = error instanceof Error ? error.message : 'An unknown error occurred';
        showError(errorMsg);
      } finally {
        setLoading(false);
      }
    });

    function setLoading(loading) {
      if (submitButton) {
        submitButton.disabled = loading;
      }
      if (buttonText) {
        buttonText.style.display = loading ? 'none' : 'inline';
      }
      if (spinner) {
        spinner.classList.toggle('hidden', !loading);
      }
    }

    function showError(message) {
      if (errorMessage) {
        errorMessage.textContent = message;
      }
      if (errorDiv) {
        errorDiv.classList.remove('hidden');
      }
    }

    function hideError() {
      if (errorDiv) {
        errorDiv.classList.add('hidden');
      }
    }
  </script>
</Layout>

---
import "../../styles/global.css";
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>Login - Capsulo CMS</title>
  </head>
  <body class="min-h-screen bg-background flex items-center justify-center">
    <div class="w-full max-w-md mx-auto p-6">
      <div
        class="bg-card text-card-foreground shadow-sm border rounded-lg p-6 space-y-6"
      >
        <div class="text-center space-y-2">
          <h1 class="text-2xl font-bold">Login to Capsulo CMS</h1>
          <p class="text-sm text-muted-foreground">
            Enter your GitHub Personal Access Token to access the CMS.
          </p>
        </div>

        <form id="loginForm" class="space-y-4">
          <div class="space-y-2">
            <label
              for="token"
              class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
              >GitHub Personal Access Token</label
            >
            <input
              id="token"
              type="password"
              placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
              required
              class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
            />
            <p class="text-xs text-muted-foreground">
              Token needs <code>repo</code> and <code>user:email</code> scopes.
            </p>
          </div>

          <div
            id="error"
            class="hidden text-sm text-red-600 bg-red-50 p-3 rounded-md"
          >
          </div>

          <button
            type="submit"
            class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 w-full"
          >
            <span class="button-text">Login</span>
          </button>
        </form>

        <div class="text-xs text-muted-foreground space-y-2">
          <p class="font-medium">How to create a Personal Access Token:</p>
          <ol class="list-decimal list-inside space-y-1 ml-2">
            <li>
              Go to GitHub Settings → Developer settings → Personal access
              tokens
            </li>
            <li>
              Generate new token with <code>repo</code> and <code
                >user:email</code
              > scopes
            </li>
            <li>Copy and paste the token above</li>
          </ol>
        </div>
      </div>
    </div>

    <script>
      const form = document.getElementById("loginForm");
      const tokenInput = document.getElementById("token");
      const errorDiv = document.getElementById("error");
      const buttonText = document.querySelector(".button-text");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const token = tokenInput.value.trim();
        if (!token) {
          showError("Please enter a valid GitHub token");
          return;
        }

        setLoading(true);
        hideError();

        try {
          // Validate token by fetching user data
          const userResponse = await fetch("https://api.github.com/user", {
            headers: {
              Authorization: `Bearer ${token}`,
              Accept: "application/vnd.github.v3+json",
            },
          });

          if (!userResponse.ok) {
            throw new Error("Invalid GitHub token");
          }

          const user = await userResponse.json();

          // Check repository access
          const repoResponse = await fetch(
            "https://api.github.com/repos/oriolmontcreus/orbitas",
            {
              headers: {
                Authorization: `Bearer ${token}`,
                Accept: "application/vnd.github.v3+json",
              },
            },
          );

          if (!repoResponse.ok) {
            throw new Error("You do not have access to this repository");
          }

          // Store authentication data
          localStorage.setItem("github_access_token", token);
          localStorage.setItem("github_user_data", JSON.stringify(user));

          // Redirect to main page
          window.location.href = "/";
        } catch (error) {
          showError(error.message);
        } finally {
          setLoading(false);
        }
      });

      function setLoading(loading) {
        const button = form.querySelector('button[type="submit"]');
        button.disabled = loading;
        buttonText.textContent = loading ? "Authenticating..." : "Login";
      }

      function showError(message) {
        errorDiv.textContent = message;
        errorDiv.classList.remove("hidden");
      }

      function hideError() {
        errorDiv.classList.add("hidden");
      }
    </script>
  </body>
</html>
